<%- include('../userLayouts/header.ejs') %>


    <div class="page-wrapper">
        
        <%- include('../userLayouts/pageHeader.ejs') %>

        <main class="main">
        	<!-- <div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h1 class="page-title">My Account<span>Shop</span></h1>
        		</div>
        	</div> -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav mb-3">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active" aria-current="page">My Account</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
            	<div class="dashboard">
	                <div class="container">
	                	<div class="row">
	                		<aside class="col-md-4 col-lg-3">
	                			<ul class="nav nav-dashboard flex-column mb-3 mb-md-0" role="tablist">
								    <li class="nav-item">
								        <a class="nav-link active" id="tab-dashboard-link" data-toggle="tab" href="#tab-dashboard" role="tab" aria-controls="tab-dashboard" aria-selected="true">Dashboard</a>
								    </li>
								    <li class="nav-item">
								        <a class="nav-link" id="tab-orders-link" data-toggle="tab" href="#tab-orders" role="tab" aria-controls="tab-orders" aria-selected="false">Orders</a>
								    </li>
								    <li class="nav-item">
								        <a class="nav-link" id="tab-address-link" data-toggle="tab" href="#tab-address" role="tab" aria-controls="tab-address" aria-selected="false">Adresses</a>
								    </li>
								    <li class="nav-item">
								        <a class="nav-link" id="tab-account-link" data-toggle="tab" href="#tab-account" role="tab" aria-controls="tab-account" aria-selected="false">Account Details</a>
								    </li>
								    <li class="nav-item">
								        <a id="logoutLink" class="nav-link" href="/logout">Sign Out</a>
								    </li>
								</ul>
	                		</aside><!-- End .col-lg-3 -->

	                		<div class="col-md-8 col-lg-9">
	                			<div class="tab-content">
								    <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel" aria-labelledby="tab-dashboard-link">
								    	<p>Hello <span class="font-weight-normal text-dark"><%- user.name %>,</span></p>

                                        <p>Your Email : <span class="font-weight-normal text-dark"><%- user.email %></span></p>

                                        <p>Your Mobile Number : <span class="font-weight-normal text-dark">
                                            <% if (!user.number) { %>
                                                <a href="#tab-account" class="tab-trigger-link link-underline">Add A Mobile Number</a>
                                            <% } else { %>
                                                <%- user.number  %>
                                            <% } %>
                                        </span></p>

                                        <p>You Have Currently <span class="font-weight-normal text-dark"><strong><%= Orders.length %></strong></span> Orders</p>

								    	<p>From your account dashboard you can view your <a href="#tab-orders" class="tab-trigger-link link-underline">recent orders</a>, manage your <a href="#tab-address" class="tab-trigger-link">shipping and billing addresses</a>, and <a href="#tab-account" class="tab-trigger-link">edit your password and account details</a>.</p>
								    </div><!-- .End .tab-pane -->

								    <div class="tab-pane fade" id="tab-orders" role="tabpanel" aria-labelledby="tab-orders-link">
										<% if (Orders.length === 0) { %>
											<div class="no-orders text-center">
												<p>No orders have been made yet.</p>
												<a href="/category" class="btn btn-primary"><span>Go Shopping</span><i class="icon-long-arrow-right"></i></a>
											</div>
										<% } else { %>
											<div class="orders-list">
												<% Orders.forEach((order, index) => { %>
													<div class="order-card card mb-4">
														<div class="card-body">
															<h3 class="card-title mb-3">Order <%= index + 1 %> :</h3>
															<div class="products-list">
																<% for(let i = 0; i < order.products.length; i++) { %>
																	<% if (order.products[i].product) { %>
																		<div class="product">
																			<a href="" class="product-name"><%= order.products[i].product.name %></a>
																			<a href="" class="product-price">₹ <%= order.products[i].product.price %>.00 x <%= order.products[i].quantity %> = ₹ <%= order.products[i].product.price * order.products[i].quantity %>.00</a>
																		</div>
																	<% } else { %>
																		<div class="product">
																			<span>Product is null</span>
																		</div>
																	<% } %>
																<% } %>
															</div>
															<div class="order-details">
																<p class="total-price"><strong>Total Price:</strong> ₹ <%= order.order_total %>.00</p>
																<p class="order-status"><strong>Order Status:</strong> <%= order.order_status %></p>
															</div>
															<div class="button-details">
																<a class="btn btn-info btn-sm">Details</a>
																<button onclick="deleteOrder('<%= order._id %>')" class="btn btn-danger btn-sm">Delete Order</button>
															</div>
														</div><!-- End .card-body -->
													</div><!-- End .order-card -->
												<% }); %>
											</div><!-- End .orders-list -->
										<% } %>
									</div><!-- .End .tab-pane -->																									

								    <div class="tab-pane fade" id="tab-downloads" role="tabpanel" aria-labelledby="tab-downloads-link">
								    	<p>No downloads available yet.</p>
								    	<a href="category.html" class="btn btn-outline-primary-2"><span>GO SHOP</span><i class="icon-long-arrow-right"></i></a>
								    </div><!-- .End .tab-pane -->

								    <div class="tab-pane fade" id="tab-address" role="tabpanel" aria-labelledby="tab-address-link">

										<h3 class="card-title mb-1"><b><u>Billing Address</u></b></h3><!-- End .card-title -->

										<% if (typeof addressPageMessage !== 'undefined') { %>
											<p style="color: red;" class="d-inline-flex p-2 " ><%= addressPageMessage %>*</p>
										<% } %>

								    	<p>The <b>1st address</b> will be used on the checkout page by default.</p>

								    	<div class="row">
											<% if (address.length == 0) { %>
												<p>There has no Address Added</p>
											<% } else { %>
												<% for (let i = 0; i < address.length; i++) { %>
													<div class="col-lg-6">
														<div class="card card-dashboard">
															<div class="card-body">
		
																<p><b>SI : </b><%= i + 1 %><br>
																	<b>Name : </b><%= address[i].name %><br>
																    <b>Mobile Number : </b><%= address[i].mobileNumber %><br>
																    <b>Location : </b><%= address[i].locality %>, <%= address[i].city %>, <%= address[i].state %><br>
																    <b>Pincode : </b><%= address[i].pincode %><br>
																   <% if (address[i].landmark !== null) { %>
																	<b>Landmark : </b><%= address[i].landmark %><br>
																   <% } else { } %>
																   <% if (address[i].mobileNumber2 !== null) { %>
																	<b>Secondary Number : </b><%= address[i].mobileNumber2 %><br>
																   <% } else { } %>
																<a onmouseover="this.style.textDecoration = 'underline'" onmouseout="this.style.textDecoration = 'none'" href="/editAddress?id=<%= address[i]._id %>" class="mr-3">Edit <i class="icon-edit"></i></a>
																<a onmouseover="this.style.textDecoration = 'underline'; this.style.cursor = 'pointer'" onmouseout="this.style.textDecoration = 'none'" onclick="deleteAddress('<%= address[i].id %>')" style="color: #d15a5e;">Delete<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="14px" fill="#d15a5e"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg></a></p>
															</div><!-- End .card-body -->
														</div><!-- End .card-dashboard -->
													</div><!-- End .col-lg-6 -->
		
												<% } %>
											<% } %>

								    		<div class="col-lg-6">
								    			<div class="card card-dashboard">
								    				<div class="card-body">
								    					<h3 class="card-title">Shipping Address</h3><!-- End .card-title -->

														<p>You Can Add upto 5 Adresses(<%= 5 - address.length %> remaining).<br>
														<a href="/addAddress">Add new Address <i class="icon-edit"></i></a></p>
								    				</div><!-- End .card-body -->
								    			</div><!-- End .card-dashboard -->
								    		</div><!-- End .col-lg-6 -->
								    	</div><!-- End .row -->
								    </div><!-- .End .tab-pane -->

								    <div class="tab-pane fade" id="tab-account" role="tabpanel" aria-labelledby="tab-account-link">
								    	<form action="#">

		            						<label>Display Name *</label>
		            						<input type="text" class="form-control" required>
		            						<small class="form-text">This will be how your name will be displayed in the account section and in reviews</small>

		                					<label>Email address *</label>
		        							<input type="email" class="form-control" required>

                                            <label>Mobile Number (leave blank to leave unchanged)</label>
		        							<input type="text" class="form-control">

		            						<label>Current password (leave blank to leave unchanged)</label>
		            						<input type="password" class="form-control">

		            						<label>New password (leave blank to leave unchanged)</label>
		            						<input type="password" class="form-control">

		            						<label>Confirm new password</label>
		            						<input type="password" class="form-control mb-2">

		                					<button type="submit" class="btn btn-outline-primary-2">
			                					<span>SAVE CHANGES</span>
			            						<i class="icon-long-arrow-right"></i>
			                				</button>
			                			</form>
								    </div><!-- .End .tab-pane -->
								</div>
	                		</div><!-- End .col-lg-9 -->
	                	</div><!-- End .row -->
	                </div><!-- End .container -->
                </div><!-- End .dashboard -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->

        <%- include('../userLayouts/pageFooter.ejs') %>
            
    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

	<script>

		function deleteAddress(addressId) {
			Swal.fire({
				title: 'Are you sure?',
				text: 'Once deleted, you will not be able to recover this address!',
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: 'Yes, delete it!'
			}).then((result) => {
				if (result.isConfirmed) {
					// If the user confirms, proceed with the deletion
					fetch('/profile', {
						method: 'post',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ addressId: addressId }),
					})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						return response.json();
					})
					.then(data => {
						if(data.message == 'Failed') {
							console.log('Address Not Found')
						} else {
							// Reload the page after deletion
							window.location.reload();
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
				}
			});
		}


		document.addEventListener('DOMContentLoaded', function () {
			// Get the "Sign Out" link
			var logoutLink = document.getElementById('logoutLink');

			// Add click event listener
			logoutLink.addEventListener('click', function (event) {
				// Prevent the default action of the link
				event.preventDefault();

				// Display SweetAlert confirmation dialog
				Swal.fire({
					title: 'Are you sure you want to sign out?',
					icon: 'warning',
					showCancelButton: true,
					confirmButtonColor: '#3085d6',
					cancelButtonColor: '#d33',
					confirmButtonText: 'Confirm',
					cancelButtonText: 'Cancel'
				}).then((result) => {
					// If user confirms, proceed with logout
					if (result.isConfirmed) {
						window.location.href = logoutLink.href;
					}
				});
			});
		});

		function deleteOrder(OrderId) {
			Swal.fire({
				title: 'Are you sure you want to delete this order?',
				text: 'Once deleted, you will not be able to recover it!',
				icon: 'warning',
				showCancelButton: true,
				confirmButtonColor: '#d33',
				cancelButtonColor: '#3085d6',
				confirmButtonText: 'Yes, delete it!'
			}).then((result) => {
				if (result.isConfirmed) {
					fetch('/profile', {
						method: 'post',
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({ OrderId: OrderId }),
					})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						return response.json();
					})
					.then(data => {
						if(data.message == 'Success') {
							Swal.fire({
								title: 'Success!',
								text: 'Order has been deleted successfully.',
								icon: 'success'
							}).then(() => {
								window.location.reload();
							});
						} else {
							Swal.fire({
								title: 'Error!',
								text: 'Failed to delete order.',
								icon: 'error'
							}).then(() => {
								window.location.reload();
							});
						}
					})
					.catch(error => {
						console.error('Error:', error);
					});
				}
			});
		}

	</script>
    
<%- include('../userLayouts/footer.ejs') %>