
<%- include('../adminLayouts/header.ejs') %>

<%- include('../adminLayouts/pageHeader.ejs') %>

    <section class="content-main">
        <div class="row">
            <div class="col-9">
                <div class="content-header">
                    <h2 class="content-title">Edit Product</h2>
                    <div>
                        <button class="btn btn-light rounded font-sm mr-5 text-body hover-up">Save to draft</button>
                    </div>
                </div>
            </div>
            <div class="col-9">
                <div class="card">
                    <div class="card-body">
                        <div class="row gx-5">
                            <aside class="col-lg-3 border-end">
                                <nav class="nav nav-pills flex-column mb-4">
                                    <a class="nav-link active" aria-current="page" href="#">General</a>
                                    <!-- <a class="nav-link" href="/admin/addproductPrice">Pricing</a>
                                    <a class="nav-link" href="/admin/addproductImages">Images</a>
                                    <a class="nav-link" href="/admin/addproductRelatedproducts">Related items</a> -->
                                </nav>
                            </aside>
                            <div class="col-lg-9">
                                <section class="content-body p-xl-4">
                                    <form method="post" enctype="multipart/form-data">
                                        <% if (typeof message !== 'undefined') { %>
											<p style="color: red;" class="d-inline-flex p-2 " ><%= message %>*</p>
										<% } %>
                                        <div class="row mb-4">
                                            <label class="col-lg-3 col-form-label">Product name*</label>
                                            <div class="col-lg-9">
                                                <input type="text" name="productName" class="form-control" value="<%- product.name %>" placeholder="Type here" />
                                            </div>
                                            <!-- col.// -->
                                        </div>
                                        <!-- row.// -->
                                        <div class="row mb-4">
                                            <label class="col-lg-3 col-form-label">Description*</label>
                                            <div class="col-lg-9">
                                                <textarea class="form-control" name="productDescription" placeholder="Type here" rows="4"><%- product.description %></textarea>
                                            </div>
                                            <!-- col.// -->
                                        </div>
                                        <!-- row.// -->
                                        <div class="row mb-4">
                                            <label class="col-lg-3 col-form-label">Category*</label>
                                            <div class="col-lg-4">
                                                <select class="form-select" name="productCategory">
                                                    <% for (let i = 0; i < categories.length; i++) { %>
                                                        <% if (categories[i].name === product.category) { %>
                                                            <option selected ><%= categories[i].name %></option>
                                                        <% } else { %>
                                                            <option><%= categories[i].name %></option>
                                                        <% } %>
                                                    <% } %>
                                                </select>
                                                <!-- <select multiple size="4" name="productCategory" class="form-control select-multiple">
                                                    <% for(let i = 0; i < categories.length; i++) { %>
                                                        <option><%= categories[i].name %></option>
                                                    <% } %>
                                                </select> -->
                                            </div>
                                            <!-- col.// -->
                                        </div>
                                        <div class="row mb-4">
                                            <label class="col-lg-3 col-form-label">Price*</label>
                                            <div class="col-lg-9">
                                                <input type="number" name="productPrice" value="<%- product.price %>" class="form-control" placeholder="Type here" />
                                            </div>
                                            <!-- col.// -->
                                        </div>
                                        <div class="row mb-4">
                                            <label class="col-lg-3 col-form-label">Stock*</label>
                                            <div class="col-lg-9">
                                                <input type="number" name="productStock" value="<%- product.stock %>" class="form-control" placeholder="Type here" />
                                            </div>
                                            <!-- col.// -->
                                        </div>
                                        <div class="row mb-4">
                                            <label class="col-lg-3 col-form-label">Add 4 images*</label>
                                            <div class="col-lg-9">
                                                <input type="file" accept=".png, .jpeg, .jpg" value="<%= product.product_image %>" name="image_1" class="form-control" placeholder="Type here" onchange="previewImage(event, 'image-preview-1')" multiple/>
                                                <div id="image-preview-1" class="mt-3">
                                                    <% for(let i = 0; i < product.product_image.length; i++) { %>
                                                        <div class="image-container" style="display: inline-block; position: relative; margin: 10px;">
                                                            <img src="<%= CLOUDINARY_IMAGE_PREFIX %><%= product.product_image[i] %>" 
                                                                 style="width: 100px; height: 100px;" 
                                                                 class="img-fluid img-thumbnail" />
                                                
                                                            <button type="button" 
                                                                    class="delete-image-btn" 
                                                                    data-image="<%= product.product_image[i] %>" 
                                                                    style="position: absolute; top: 5px; right: 5px; 
                                                                           background: red; color: white; border: none; border-radius: 4px; padding: 2px 5px;">
                                                                X
                                                            </button>
                                                        </div>
                                                    <% } %>
                                                </div>                                                
                                            </div>
                                            <!-- col.// -->
                                        </div>
                                        <!-- row.// -->
                                        <div class="row mb-4">
                                            <label class="col-lg-3 col-form-label">Ram*</label>
                                            <div class="col-lg-4">
                                                <input type="tel" name="productRam" value="<%- product.ram %>" class="form-control" placeholder="Type" />
                                            </div>
                                            <!-- col.// -->
                                        </div><!-- row.// -->
                                        <div class="row mb-4">
                                            <label class="col-lg-3 col-form-label">Storage*</label>
                                            <div class="col-lg-4">
                                                <input type="tel" name="productStorage" value="<%- product.storage %>" class="form-control" placeholder="Type" />
                                            </div>
                                            <!-- col.// -->
                                        </div>
                                        <!-- row.// -->
                                        <br />
                                        <input type="hidden" name="id" value="<%= product._id %>">
                                        <button class="btn btn-primary" type="submit" >Edit Product</button>
                                    </form>
                                </section>
                                <!-- content-body .// -->
                            </div>
                            <!-- col.// -->
                        </div>
                        <!-- row.// -->
                    </div>
                    <!-- card body end// -->
                </div>
            </div>
        </div>
    </section>

    <%- include('../adminLayouts/pageFooter.ejs') %>

    <script>
        function previewImage(event, previewId) {
            const previewContainer = document.getElementById(previewId);
            const files = Array.from(event.target.files);

            const WIDTH = 100;
            const MAX_IMAGES = 4;

            // Clear previous error messages
            previewContainer.querySelectorAll(".alert-message").forEach(el => el.remove());

            // Check max limit
            const existingImages = previewContainer.querySelectorAll('.image-container').length;
            if (existingImages + files.length > MAX_IMAGES) {
                const alertMessage = document.createElement("p");
                alertMessage.style.color = "red";
                alertMessage.className = "alert-message";
                alertMessage.innerHTML = `Maximum ${MAX_IMAGES} files allowed*.`;
                previewContainer.appendChild(alertMessage);
                event.target.value = ''; 
                return;
            }

            files.forEach((file) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onload = (e) => {
                    const image_url = e.target.result;

                    const img = new Image();
                    img.src = image_url;

                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        const ratio = WIDTH / img.width;
                        canvas.width = WIDTH;
                        canvas.height = img.height * ratio;

                        const context = canvas.getContext("2d");
                        context.drawImage(img, 0, 0, canvas.width, canvas.height);

                        const new_image_url = canvas.toDataURL("image/jpeg", 90);

                        // Create container for image + delete button
                        const container = document.createElement("div");
                        container.className = "image-container";
                        container.style.cssText = "display:inline-block; position:relative; margin:10px;";

                        const newImage = document.createElement("img");
                        newImage.src = new_image_url;
                        newImage.style.cssText = "width:100px; height:100px;";

                        // Delete button
                        const deleteBtn = document.createElement("button");
                        deleteBtn.innerHTML = "X";
                        deleteBtn.type = "button";
                        deleteBtn.style.cssText = "position:absolute; top:5px; right:5px; background:red; color:white; border:none; border-radius:4px; padding:2px 5px;";

                        deleteBtn.addEventListener("click", () => {
                            container.remove();
                        });

                        container.appendChild(newImage);
                        container.appendChild(deleteBtn);
                        previewContainer.appendChild(container);
                    };
                };
            });
        }

        /*****         To remove image from the product           *****/
        document.querySelectorAll('.delete-image-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const imageName = e.target.getAttribute('data-image');
                const confirmed = await Swal.fire({
                    title: `Delete ${imageName}?`,
                    text: "This action cannot be undone.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel'
                });               
                if (!confirmed) return;

                try {
                    // Send request to backend to delete image
                    const response = await fetch(`/admin/product/<%= product._id %>/delete-image`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imageName })
                    });
                    const data = await response.json();
                    if (data.success) {
                        e.target.closest('.image-container').remove();
                    } else {
                        alert('Error deleting image: ' + data.message);
                    }
                } catch (err) {
                    alert('Server error while deleting image.');
                }
            });
        });
    </script>
    

<%- include('../adminLayouts/footer.ejs') %>
